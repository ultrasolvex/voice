<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>🎙️ School Voice — النسخة النهائية</title>
<style>
:root { --bg1:#081325; --bg2:#391a61; }
body {
  margin:0; height:100vh;
  display:flex; align-items:center; justify-content:center;
  background:linear-gradient(to bottom,var(--bg1),var(--bg2));
  font-family:'Tajawal',sans-serif; color:#fff;
}
.card {
  width:95%; max-width:800px; background:rgba(255,255,255,0.05);
  border-radius:14px; padding:18px; box-shadow:0 10px 30px rgba(0,0,0,0.4);
}
input, button {
  border:none; border-radius:10px; padding:10px;
  font-size:16px;
}
input { flex:1; background:rgba(255,255,255,0.08); color:#fff; }
button {
  background:linear-gradient(90deg,#6d2fb0,#2c77ff);
  color:#fff; cursor:pointer; font-weight:600;
}
.row { display:flex; gap:8px; }
.status { margin-top:12px; background:rgba(0,0,0,0.3); padding:10px; border-radius:10px; font-size:14px; }
.peers { display:flex; flex-direction:column; gap:6px; margin-top:8px; }
.peer { background:rgba(255,255,255,0.08); padding:6px 10px; border-radius:8px; font-size:13px; }
.overlay {
  position:fixed; inset:0; background:rgba(0,0,0,0.7);
  display:flex; align-items:center; justify-content:center;
  z-index:9999;
}
.overlay button {
  padding:14px 22px; font-size:18px; border-radius:12px;
  background:linear-gradient(90deg,#6d2fb0,#2c77ff);
  border:none; color:#fff; cursor:pointer;
}
</style>
</head>
<body>
  <div class="card">
    <h2>🎧 School Voice</h2>
    <p>اكتب اسم الغرفة واضغط "انضم" على جهازين بنفس الاسم لتسمع الصوت بينهما.</p>
    <div class="row">
      <input id="room" placeholder="اسم الغرفة (مثلاً: room1)" />
      <button id="join">انضم</button>
    </div>
    <button id="mute" style="display:none;margin-top:10px;background:#ff4d4d;">🔇 كتم المايك</button>
    <div class="status" id="status">غير متصل</div>
    <div class="peers" id="peers"><div class="peer">لا أحد متصل حالياً</div></div>
  </div>

  <div id="overlay" class="overlay" style="display:none">
    <button id="startAudio">🎵 اضغط لتفعيل الصوت</button>
  </div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, onChildAdded, remove, get, onDisconnect } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

// 🔧 إعداد Firebase
const firebaseConfig = {
  apiKey: "AIzaSyAQ6gD7dayX_VRzSIsI5UecS212Ki4N16o",
  authDomain: "school-voice-1b1dc.firebaseapp.com",
  databaseURL: "https://school-voice-1b1dc-default-rtdb.firebaseio.com",
  projectId: "school-voice-1b1dc",
  storageBucket: "school-voice-1b1dc.firebasestorage.app",
  messagingSenderId: "990135804919",
  appId: "1:990135804919:web:38c050a3a2ed1cb8d304f2"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const joinBtn = document.getElementById("join");
const muteBtn = document.getElementById("mute");
const roomInput = document.getElementById("room");
const peersEl = document.getElementById("peers");
const statusEl = document.getElementById("status");
const overlay = document.getElementById("overlay");
const startAudioBtn = document.getElementById("startAudio");

let roomName, localStream, micEnabled = true;
const peerId = Math.random().toString(36).substring(2,8);
const pcs = {}, audios = {};
const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

joinBtn.onclick = joinRoom;
muteBtn.onclick = toggleMic;
startAudioBtn.onclick = enableAudioPlayback;

async function joinRoom() {
  roomName = roomInput.value.trim();
  if (!roomName) return alert("⚠️ اكتب اسم الغرفة أولاً.");

  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  } catch {
    return alert("🚫 لم يُسمح بالمايكروفون، يرجى السماح به.");
  }

  muteBtn.style.display = "inline-block";
  statusEl.textContent = "📡 جاري الاتصال...";

  const myRef = ref(db, `rooms/${roomName}/peers/${peerId}`);
  await set(myRef, { id: peerId });
  onDisconnect(myRef).remove();

  const peersRef = ref(db, `rooms/${roomName}/peers`);
  onValue(peersRef, (snap) => {
    const peers = Object.keys(snap.val() || {}).filter(p => p !== peerId);
    renderPeers(peers);
  });

  const sigRef = ref(db, `signals/${roomName}/${peerId}`);
  onChildAdded(sigRef, async (snap) => {
    const msg = snap.val(); if (!msg) return;
    const from = msg.from;
    switch (msg.type) {
      case "offer":
        const pc1 = await createPC(from);
        await pc1.setRemoteDescription(msg.sdp);
        const ans = await pc1.createAnswer();
        await pc1.setLocalDescription(ans);
        sendSig(from, { from: peerId, type: "answer", sdp: pc1.localDescription });
        break;
      case "answer":
        pcs[from]?.setRemoteDescription(msg.sdp);
        break;
      case "ice":
        if (msg.candidate) pcs[from]?.addIceCandidate(msg.candidate).catch(()=>{});
        break;
    }
    remove(snap.ref);
  });

  const peersSnap = await get(ref(db, `rooms/${roomName}/peers`));
  const peers = peersSnap.val() || {};
  for (const id in peers) if (id !== peerId) await createPC(id, true);

  statusEl.textContent = `✅ متصل في "${roomName}"`;
  overlay.style.display = "flex";
}

async function createPC(otherId, offerer = false) {
  if (pcs[otherId]) return pcs[otherId];
  const pc = new RTCPeerConnection(config);
  pcs[otherId] = pc;

  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  pc.ontrack = (e) => {
    let a = audios[otherId];
    if (!a) {
      a = document.createElement("audio");
      a.autoplay = true;
      a.playsInline = true;
      a.muted = false;
      audios[otherId] = a;
      peersEl.appendChild(a);
    }
    a.srcObject = e.streams[0];

    // ✅ إجبار الصوت على التشغيل فور وصوله
    setTimeout(() => { a.play().catch(()=>{}); }, 500);
  };

  pc.onicecandidate = (e) => {
    if (e.candidate) sendSig(otherId, { from: peerId, type: "ice", candidate: e.candidate });
  };

  if (offerer) {
    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    sendSig(otherId, { from: peerId, type: "offer", sdp: pc.localDescription });
  }
  return pc;
}

function sendSig(target, data) {
  push(ref(db, `signals/${roomName}/${target}`), data);
}

function renderPeers(list) {
  peersEl.innerHTML = "";
  if (!list.length) return peersEl.innerHTML = "<div class='peer'>لا أحد متصل حالياً</div>";
  list.forEach(id => peersEl.innerHTML += `<div class='peer'>🎙️ مستخدم ${id}</div>`);
}

function toggleMic() {
  micEnabled = !micEnabled;
  localStream?.getAudioTracks().forEach(t => t.enabled = micEnabled);
  muteBtn.textContent = micEnabled ? "🔇 كتم المايك" : "🎙️ تشغيل المايك";
}

function enableAudioPlayback() {
  Object.values(audios).forEach(a => {
    try { a.muted = false; a.play().catch(()=>{}); } catch {}
  });
  overlay.style.display = "none";
}
</script>
</body>
</html>
