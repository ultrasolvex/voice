<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>صوتنا – دردشة صوتية فاخرة</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1426;
      --card: #131d35;
      --accent: #00e0ff;
      --accent-dark: #00a8cc;
      --text: #e0f7ff;
      --muted: #88c0d0;
      --danger: #e74c3c;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, var(--bg), #1a2a44);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    h2 {
      margin: 20px 0 10px;
      font-size: 26px;
      color: var(--accent);
      text-shadow: 0 0 10px rgba(0, 224, 255, 0.3);
    }

    #roomList {
      background: rgba(19, 29, 53, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 224, 255, 0.2);
      border-radius: 18px;
      padding: 16px;
      width: 100%;
      max-width: 420px;
      height: 380px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }

    .room {
      background: rgba(255, 255, 255, 0.08);
      padding: 14px;
      border-radius: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .room:hover {
      background: rgba(0, 224, 255, 0.15);
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 224, 255, 0.2);
    }

    .room b { font-weight: 700; font-size: 16px; }
    .room span { 
      background: rgba(0, 0, 0, 0.3); 
      padding: 4px 10px; 
      border-radius: 20px; 
      font-size: 13px; 
      color: var(--accent);
    }

    .empty {
      color: var(--muted);
      font-size: 15px;
      padding: 30px;
      text-align: center;
    }

    .footer {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    input {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(0, 224, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      width: 200px;
      font-size: 15px;
    }

    input::placeholder { color: #88c0d0; }

    button {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 0 4px 15px rgba(0, 224, 255, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 224, 255, 0.4);
    }

    button.danger {
      background: var(--danger);
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }

    #chatArea {
      margin-top: 30px;
      width: 100%;
      max-width: 420px;
      display: none;
    }

    #participants {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin: 20px 0;
    }

    .participant {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: var(--card);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      position: relative;
      border: 2px solid transparent;
      transition: 0.3s;
    }

    .participant.speaking {
      border-color: var(--accent);
      box-shadow: 0 0 20px rgba(0, 224, 255, 0.6);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    .mic {
      position: absolute;
      bottom: 6px;
      font-size: 12px;
      color: var(--accent);
    }

    audio { display: none; }
  </style>
</head>
<body>

  <h2>صوتنا – دردشة صوتية فاخرة</h2>

  <div id="roomList"></div>

  <div class="footer">
    <input id="roomNameInput" placeholder="اسم الغرفة الجديدة" />
    <button id="createRoomBtn">إنشاء غرفة</button>
  </div>

  <div id="chatArea">
    <h3 id="roomTitle" style="color:var(--accent);margin-bottom:10px"></h3>
    <div id="participants"></div>
    <button id="leaveBtn" class="danger">خروج</button>
  </div>

  <!-- Firebase + WebRTC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    // Firebase Config (اللي أنت جبته)
    const firebaseConfig = {
      apiKey: "AIzaSyAQ6gD7dayX_VRzSIsI5UecS212Ki4N16o",
      authDomain: "school-voice-1b1dc.firebaseapp.com",
      databaseURL: "https://school-voice-1b1dc-default-rtdb.firebaseio.com",
      projectId: "school-voice-1b1dc",
      storageBucket: "school-voice-1b1dc.firebasestorage.app",
      messagingSenderId: "990135804919",
      appId: "1:990135804919:web:38c050a3a2ed1cb8d304f2",
      measurementId: "G-Y8Z1NP232P"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const clientId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    let myName = prompt("ادخل اسمك:") || "ضيف";
    let currentRoom = null;
    let localStream = null;
    const peers = {};
    const iceServers = {
  iceServers: [
    { urls: 'stun:stun.l.google.com:19302' },
    {
      urls: [
        'turn:global.relay.metered.ca:80',
        'turn:global.relay.metered.ca:443',
        'turns:global.relay.metered.ca:443?transport=tcp'
      ],
      username: 'openai',
      credential: 'openai'
    }
  ]
};

    const roomList = document.getElementById("roomList");
    const chatArea = document.getElementById("chatArea");
    const roomTitle = document.getElementById("roomTitle");
    const participants = document.getElementById("participants");
    const leaveBtn = document.getElementById("leaveBtn");

    // تحديث قائمة الرومات
    onValue(ref(db, 'rooms'), (snap) => {
      const rooms = snap.val() || {};
      roomList.innerHTML = '';
      const active = Object.entries(rooms).filter(([_, data]) => data.users && Object.keys(data.users).length > 0);

      if (active.length === 0) {
        roomList.innerHTML = '<div class="empty">لا توجد غرف مفتوحة الآن</div>';
      } else {
        active.slice(0, 7).forEach(([roomId, data]) => {
          const div = document.createElement('div');
          div.className = 'room';
          div.innerHTML = `<b>${data.name}</b><span>${Object.keys(data.users).length} متصل</span>`;
          div.onclick = () => joinRoom(roomId, data.name);
          roomList.appendChild(div);
        });
      }
    });

    // إنشاء غرفة
    document.getElementById("createRoomBtn").onclick = () => {
      const name = document.getElementById("roomNameInput").value.trim();
      if (!name) return alert("اكتب اسم الغرفة");
      const roomRef = push(ref(db, 'rooms'));
      set(roomRef, { name, host: clientId, created: Date.now(), users: {} });
      joinRoom(roomRef.key, name);
    };

    // الانضمام
    async function joinRoom(roomId, roomName) {
      currentRoom = roomId;
      roomTitle.textContent = `أنت في: ${roomName}`;
      chatArea.style.display = 'block';
      document.querySelector('.footer').style.display = 'none';
      roomList.style.display = 'none';

      const userRef = ref(db, `rooms/${roomId}/users/${clientId}`);
      await set(userRef, { name: myName, joined: Date.now() });
      onDisconnect(userRef).remove();

      localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      document.body.appendChild(Object.assign(document.createElement('audio'), { srcObject: localStream, muted: true, autoplay: true }));

      onValue(ref(db, `rooms/${roomId}/users`), (snap) => {
        const users = snap.val() || {};
        participants.innerHTML = '';
        Object.entries(users).forEach(([id, user]) => {
          if (id !== clientId) createPeerConnection(id, true);
          const el = document.createElement('div');
          el.className = 'participant';
          el.innerHTML = `<div>${user.name.split(' ')[0]}</div><div class="mic">ميكروفون</div>`;
          el.id = `peer-${id}`;
          participants.appendChild(el);
        });
      });

      onValue(ref(db, `signals/${roomId}`), (snap) => {
        const signals = snap.val() || {};
        Object.entries(signals).forEach(([fromId, signal]) => {
          if (fromId !== clientId && signal.to === clientId) {
            handleSignal(fromId, signal);
            remove(ref(db, `signals/${roomId}/${fromId}`));
          }
        });
      });
    }

    function createPeerConnection(peerId, isInitiator) {
      if (peers[peerId]) return;
      const pc = new RTCPeerConnection(iceServers);
      peers[peerId] = pc;

      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

      pc.ontrack = (e) => {
        const audio = new Audio();
        audio.srcObject = e.streams[0];
        audio.autoplay = true;
        document.body.appendChild(audio);

        const el = document.getElementById(`peer-${peerId}`);
        if (el) {
          el.classList.add('speaking');
          setTimeout(() => el.classList.remove('speaking'), 500);
        }
      };

      pc.onicecandidate = (e) => {
        if (e.candidate) {
          set(ref(db, `signals/${currentRoom}/${clientId}`), {
            to: peerId,
            candidate: e.candidate
          });
        }
      };

      if (isInitiator) {
        pc.createOffer()
          .then(offer => pc.setLocalDescription(offer))
          .then(() => {
            set(ref(db, `signals/${currentRoom}/${clientId}`), {
              to: peerId,
              sdp: pc.localDescription
            });
          });
      }

      pc.onconnectionstatechange = () => {
        if (pc.connectionState === 'failed') delete peers[peerId];
      };
    }

    async function handleSignal(fromId, signal) {
      let pc = peers[fromId];
      if (!pc) {
        pc = new RTCPeerConnection(iceServers);
        peers[fromId] = pc;
        localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
      }

      if (signal.sdp) {
        await pc.setRemoteDescription(signal.sdp);
        if (signal.sdp.type === 'offer') {
          const answer = await pc.createAnswer();
          await pc.setLocalDescription(answer);
          set(ref(db, `signals/${currentRoom}/${clientId}`), {
            to: fromId,
            sdp: pc.localDescription
          });
        }
      } else if (signal.candidate) {
        await pc.addIceCandidate(signal.candidate);
      }
    }

    leaveBtn.onclick = async () => {
      if (!currentRoom) return;
      await remove(ref(db, `rooms/${currentRoom}/users/${clientId}`));
      Object.values(peers).forEach(pc => pc.close());
      Object.keys(peers).forEach(id => delete peers[id]);
      localStream?.getTracks().forEach(t => t.stop());
      chatArea.style.display = 'none';
      document.querySelector('.footer').style.display = 'flex';
      roomList.style.display = 'block';
      currentRoom = null;
    };

    window.addEventListener('beforeunload', leaveBtn.onclick);
  </script>
</body>
</html>
