<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>صوتنا – دردشة صوتية فاخرة</title>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b1426;
      --card: #131d35;
      --accent: #00e0ff;
      --accent-dark: #00a8cc;
      --text: #e0f7ff;
      --muted: #88c0d0;
      --danger: #e74c3c;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Tajawal', sans-serif;
      background: linear-gradient(135deg, var(--bg), #1a2a44);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    h2 {
      margin: 20px 0 10px;
      font-size: 26px;
      color: var(--accent);
      text-shadow: 0 0 10px rgba(0, 224, 255, 0.3);
    }

    #roomList {
      background: rgba(19, 29, 53, 0.7);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 224, 255, 0.2);
      border-radius: 18px;
      padding: 16px;
      width: 100%;
      max-width: 420px;
      height: 380px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
    }

    .room {
      background: rgba(255, 255, 255, 0.08);
      padding: 14px;
      border-radius: 14px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid transparent;
    }

    .room:hover {
      background: rgba(0, 224, 255, 0.15);
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 224, 255, 0.2);
    }

    .room b { font-weight: 700; font-size: 16px; }
    .room span { 
      background: rgba(0, 0, 0, 0.3); 
      padding: 4px 10px; 
      border-radius: 20px; 
      font-size: 13px; 
      color: var(--accent);
    }

    .empty {
      color: var(--muted);
      font-size: 15px;
      padding: 30px;
      text-align: center;
    }

    .footer {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
    }

    input {
      padding: 12px;
      border-radius: 12px;
      border: 1px solid rgba(0, 224, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      width: 200px;
      font-size: 15px;
    }

    input::placeholder { color: #88c0d0; }

    button {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 0 4px 15px rgba(0, 224, 255, 0.3);
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 224, 255, 0.4);
    }

    button.danger {
      background: var(--danger);
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }

    #chatArea {
      margin-top: 30px;
      width: 100%;
      max-width: 420px;
      display: none;
    }

    #participants {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 12px;
      margin: 20px 0;
    }

    .participant {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: var(--card);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      position: relative;
      border: 2px solid transparent;
      transition: 0.3s;
    }

    .participant.speaking {
      border-color: var(--accent);
      box-shadow: 0 0 20px rgba(0, 224, 255, 0.6);
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.08); }
    }

    .mic {
      position: absolute;
      bottom: 6px;
      font-size: 12px;
      color: var(--accent);
    }

    audio { display: none; }

    #micPermission {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: white;
      font-size: 18px;
    }

    #micPermission button {
      margin-top: 20px;
      padding: 14px 30px;
      font-size: 18px;
    }
  </style>
</head>
<body>

  <!-- إذن الميكروفون -->
  <div id="micPermission">
    <div>ميكروفون</div>
    <p style="margin:15px 0; max-width:300px; text-align:center;">
      للدردشة الصوتية، نحتاج إذن الوصول للميكروفون
    </p>
    <button id="allowMic">السماح بالميكروفون</button>
  </div>

  <h2>صوتنا – دردشة صوتية فاخرة</h2>

  <div id="roomList"></div>

  <div class="footer">
    <input id="roomNameInput" placeholder="اسم الغرفة الجديدة" />
    <button id="createRoomBtn">إنشاء غرفة</button>
  </div>

  <div id="chatArea">
    <h3 id="roomTitle" style="color:var(--accent);margin-bottom:10px"></h3>
    <div id="participants"></div>
    <button id="leaveBtn" class="danger">خروج</button>
  </div>

  <!-- Firebase + WebRTC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getDatabase, ref, set, push, onValue, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAQ6gD7dayX_VRzSIsI5UecS212Ki4N16o",
      authDomain: "school-voice-1b1dc.firebaseapp.com",
      databaseURL: "https://school-voice-1b1dc-default-rtdb.firebaseio.com",
      projectId: "school-voice-1b1dc",
      storageBucket: "school-voice-1b1dc.firebasestorage.app",
      messagingSenderId: "990135804919",
      appId: "1:990135804919:web:38c050a3a2ed1cb8d304f2",
      measurementId: "G-Y8Z1NP232P"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const clientId = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    let myName = "";
    let currentRoom = null;
    let localStream = null;
    const peers = {};

    const iceServers = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        {
          urls: [
            'turn:global.relay.metered.ca:80',
            'turn:global.relay.metered.ca:443',
            'turns:global.relay.metered.ca:443?transport=tcp'
          ],
          username: 'openai',
          credential: 'openai'
        }
      ]
    };

    const micPermission = document.getElementById("micPermission");
    const allowMicBtn = document.getElementById("allowMic");
    const roomList = document.getElementById("roomList");
    const chatArea = document.getElementById("chatArea");
    const roomTitle = document.getElementById("roomTitle");
    const participants = document.getElementById("participants");
    const leaveBtn = document.getElementById("leaveBtn");

    // طلب إذن الميكروفون
    allowMicBtn.onclick = async () => {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        micPermission.style.display = 'none';

        myName = prompt("ادخل اسمك:") || "ضيف";
        if (!myName.trim()) myName = "ضيف";

        loadRooms();
      } catch (err) {
        alert("يجب السماح بالميكروفون لاستخدام التطبيق");
      }
    };

    function loadRooms() {
      onValue(ref(db, 'rooms'), (snap) => {
        const rooms = snap.val() || {};
        roomList.innerHTML = '';
        const active = Object.entries(rooms).filter(([_, d]) => d.users && Object.keys(d.users).length > 0);
        if (active.length === 0) {
          roomList.innerHTML = '<div class="empty">لا توجد غرف مفتوحة الآن</div>';
        } else {
          active.slice(0, 7).forEach(([id, d]) => {
            const div = document.createElement('div');
            div.className = 'room';
            div.innerHTML = `<b>${d.name}</b><span>${Object.keys(d.users).length} متصل</span>`;
            div.onclick = () => joinRoom(id, d.name);
            roomList.appendChild(div);
          });
        }
      });
    }

    document.getElementById("createRoomBtn").onclick = () => {
      const name = document.getElementById("roomNameInput").value.trim();
      if (!name) return alert("اكتب اسم الغرفة");
      const roomRef = push(ref(db, 'rooms'));
      set(roomRef, { name, host: clientId, created: Date.now(), users: {} });
      joinRoom(roomRef.key, name);
    };

    async function joinRoom(roomId, roomName) {
      if (!localStream) return alert("يجب السماح بالميكروفون أولاً");

      currentRoom = roomId;
      roomTitle.textContent = `أنت في: ${roomName}`;
      chatArea.style.display = 'block';
      document.querySelector('.footer').style.display = 'none';
      roomList.style.display = 'none';

      const userRef = ref(db, `rooms/${roomId}/users/${clientId}`);
      await set(userRef, { name: myName, joined: Date.now() });
      onDisconnect(userRef).remove();

      const mutedAudio = new Audio();
      mutedAudio.srcObject = localStream;
      mutedAudio.muted = true;
      mutedAudio.autoplay = true;
      document.body.appendChild(mutedAudio);

      onValue(ref(db, `rooms/${roomId}/users`), (snap) => {
        const users = snap.val() || {};
        participants.innerHTML = '';
        Object.entries(users).forEach(([id, user]) => {
          if (id !== clientId) createPeerConnection(id, true);
          const el = document.createElement('div');
          el.className = 'participant';
          el.innerHTML = `<div>${user.name.split(' ')[0]}</div><div class="mic">ميكروفون</div>`;
          el.id = `peer-${id}`;
          participants.appendChild(el);
        });
      });

      onValue(ref(db, `signals/${roomId}`), (snap) => {
        const signals = snap.val() || {};
        Object.entries(signals).forEach(([sigId, sig]) => {
          if (sig.to === clientId && sig.from !== clientId) {
            handleSignal(sig.from, sig);
            remove(ref(db, `signals/${roomId}/${sigId}`));
          }
        });
      });
    }

    function createPeerConnection(peerId, isInitiator) {
      if (peers[peerId]) return;
      const pc = new RTCPeerConnection(iceServers);
      peers[peerId] = pc;

      localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

      pc.ontrack = (e) => {
        const audio = new Audio();
        audio.srcObject = e.streams[0];
        audio.autoplay = true;
        document.body.appendChild(audio);

        const el = document.getElementById(`peer-${peerId}`);
        if (el) {
          el.classList.add('speaking');
          setTimeout(() => el.classList.remove('speaking'), 600);
        }
      };

      pc.onicecandidate = (e) => {
        if (e.candidate) {
          const sigRef = push(ref(db, `signals/${currentRoom}`));
          set(sigRef, { from: clientId, to: peerId, candidate: e.candidate });
        }
      };

      if (isInitiator) {
        pc.createOffer()
          .then(offer => pc.setLocalDescription(offer))
          .then(() => {
            const sigRef = push(ref(db, `signals/${currentRoom}`));
            set(sigRef, { from: clientId, to: peerId, sdp: pc.localDescription });
          })
          .catch(console.error);
      }

      pc.onconnectionstatechange = () => {
        if (pc.connectionState === 'failed') delete peers[peerId];
      };
    }

    async function handleSignal(fromId, signal) {
      let pc = peers[fromId];
      if (!pc) {
        pc = new RTCPeerConnection(iceServers);
        peers[fromId] = pc;
        localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
        pc.ontrack = (e) => {
          const audio = new Audio();
          audio.srcObject = e.streams[0];
          audio.autoplay = true;
          document.body.appendChild(audio);
          const el = document.getElementById(`peer-${fromId}`);
          if (el) { el.classList.add('speaking'); setTimeout(() => el.classList.remove('speaking'), 600); }
        };
        pc.onicecandidate = (e) => {
          if (e.candidate) {
            const sigRef = push(ref(db, `signals/${currentRoom}`));
            set(sigRef, { from: clientId, to: fromId, candidate: e.candidate });
          }
        };
      }

      try {
        if (signal.sdp) {
          await pc.setRemoteDescription(signal.sdp);
          if (signal.sdp.type === 'offer') {
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            const sigRef = push(ref(db, `signals/${currentRoom}`));
            set(sigRef, { from: clientId, to: fromId, sdp: pc.localDescription });
          }
        } else if (signal.candidate) {
          await pc.addIceCandidate(signal.candidate);
        }
      } catch (err) {
        console.error("Signal error:", err);
      }
    }

    leaveBtn.onclick = async () => {
      if (!currentRoom) return;
      await remove(ref(db, `rooms/${currentRoom}/users/${clientId}`));
      Object.values(peers).forEach(pc => pc.close());
      Object.keys(peers).forEach(id => delete peers[id]);
      localStream?.getTracks().forEach(t => t.stop());
      chatArea.style.display = 'none';
      document.querySelector('.footer').style.display = 'flex';
      roomList.style.display = 'block';
      currentRoom = null;
      micPermission.style.display = 'flex';
    };

    window.addEventListener('beforeunload', leaveBtn.onclick);
  </script>
</body>
</html>
