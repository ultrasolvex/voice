<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>🎙️ School Voice — إصدار محسن</title>
<style>
:root{--bg1:#081325;--bg2:#391a61}
html,body{height:100%;margin:0;font-family:'Tajawal',sans-serif;color:#fff;background:linear-gradient(180deg,var(--bg1),var(--bg2))}
.container{max-width:900px;margin:24px auto;padding:18px;border-radius:14px;background:rgba(255,255,255,0.04);box-shadow:0 12px 30px rgba(0,0,0,0.5)}
.row{display:flex;gap:8px}
input,button{border:0;border-radius:10px;padding:10px;font-size:16px}
input{flex:1;background:rgba(255,255,255,0.06);color:#fff}
button{background:linear-gradient(90deg,#6d2fb0,#2c77ff);color:#fff;cursor:pointer;font-weight:600}
.status{margin-top:12px;background:rgba(0,0,0,0.28);padding:10px;border-radius:10px;font-size:14px}
.peers{display:flex;flex-direction:column;gap:6px;margin-top:8px}
.peer{background:rgba(255,255,255,0.06);padding:8px;border-radius:8px}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:9999}
.overlay button{padding:14px 22px;font-size:18px;border-radius:12px;background:linear-gradient(90deg,#6d2fb0,#2c77ff);border:none;color:#fff;cursor:pointer}
audio{display:block;width:100%;margin-top:8px;border-radius:8px}
.small{font-size:13px;color:#ddd;margin-top:6px}
</style>
</head>
<body>
  <div class="container">
    <h2>🎧 School Voice — الإصدار المحسّن</h2>
    <p class="small">اكتب اسم الغرفة واضغط "انضم" على جهازين مختلفين بنفس الاسم. إذا منع المتصفح الصوت — اضغط زر تفعيل الصوت الظاهر بعد الاتصال.</p>

    <div class="row">
      <input id="room" placeholder="اسم الغرفة (مثلاً: room1)"/>
      <button id="join">انضم</button>
    </div>

    <div style="margin-top:10px">
      <button id="mute" style="display:none;background:#ff4d4d">🔇 كتم المايك</button>
      <button id="leave" style="display:none;margin-left:8px;background:#666">⏹️ اترك الغرفة</button>
    </div>

    <div class="status" id="status">غير متصل</div>
    <div class="peers" id="peers"><div class="peer">لا أحد متصل حالياً</div></div>
  </div>

  <div id="overlay" class="overlay" style="display:none">
    <button id="enableAudioBtn">🎵 اضغط لتفعيل الصوت الآن</button>
  </div>

<script type="module">
/* ========== imports Firebase ========== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
import {
  getDatabase, ref, set, push, onValue, onChildAdded, remove, get, onDisconnect
} from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

/* ====== إعداد Firebase - استخدم إعدادك الخاص لو عندك ====== */
const firebaseConfig = {
  apiKey: "AIzaSyAQ6gD7dayX_VRzSIsI5UecS212Ki4N16o",
  authDomain: "school-voice-1b1dc.firebaseapp.com",
  databaseURL: "https://school-voice-1b1dc-default-rtdb.firebaseio.com",
  projectId: "school-voice-1b1dc",
  storageBucket: "school-voice-1b1dc.firebasestorage.app",
  messagingSenderId: "990135804919",
  appId: "1:990135804919:web:38c050a3a2ed1cb8d304f2"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* ====== عناصر الواجهة ====== */
const joinBtn = document.getElementById('join');
const muteBtn = document.getElementById('mute');
const leaveBtn = document.getElementById('leave');
const roomInput = document.getElementById('room');
const statusEl = document.getElementById('status');
const peersEl = document.getElementById('peers');
const overlay = document.getElementById('overlay');
const enableAudioBtn = document.getElementById('enableAudioBtn');

/* ====== متغيرات الحالة ====== */
let roomName = null;
let localStream = null;
let micEnabled = true;
const peerId = Math.random().toString(36).slice(2,9);
const pcs = {};            // RTCPeerConnection per remote peer
const audios = {};         // audio elements per remote peer
const candidateQueues = {}; // queue ICE candidates until pc ready
const answered = {};       // flags when answered received
const OFFER_RETRY_MS = 1200; // retry offer frequency
const offerTimers = {};    // timers per target to resend offers
const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

/* ====== event listeners UI ====== */
joinBtn.onclick = joinRoom;
muteBtn.onclick = toggleMic;
leaveBtn.onclick = leaveRoom;
enableAudioBtn.onclick = enableAudioPlayback;

/* ====== مساعدة: تحديث الحالة ====== */
function setStatus(txt){
  statusEl.textContent = txt;
  console.log('[STATUS]', txt);
}

/* ====== دالة لإنشاء AudioContext و resume (لحل منع التشغيل) ====== */
let audioContext = null;
async function resumeAudioContext() {
  try {
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    if (audioContext.state === 'suspended') await audioContext.resume();
    // play a silent buffer to ensure audio is unlocked on some Safari versions
    const buf = audioContext.createBuffer(1, 1, 22050);
    const src = audioContext.createBufferSource();
    src.buffer = buf;
    src.connect(audioContext.destination);
    src.start();
    src.stop();
    console.log('AudioContext resumed');
  } catch (e) {
    console.warn('resumeAudioContext failed', e);
  }
}

/* ====== دالة لفتح المايك والانضمام ====== */
async function joinRoom(){
  roomName = roomInput.value.trim();
  if(!roomName){ alert('اكتب اسم الغرفة أولاً'); return; }

  setStatus('📡 طلب إذن المايك...');
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
  } catch (e) {
    alert('يرجى السماح بالمايكروفون في المتصفح.');
    setStatus('🚫 لم يتم السماح بالمايك');
    return;
  }

  // اجعل الـ UI جاهز
  muteBtn.style.display = 'inline-block';
  leaveBtn.style.display = 'inline-block';
  joinBtn.disabled = true;
  roomInput.disabled = true;

  // سجل وجودك في الغرفة في Firebase وامسح عند الانفصال
  const myRef = ref(db, `rooms/${roomName}/peers/${peerId}`);
  await set(myRef, { id: peerId, ts: Date.now() });
  onDisconnect(myRef).remove();

  // استمع لتغييرات قائمة الأقران وعرضهم
  const peersRef = ref(db, `rooms/${roomName}/peers`);
  onValue(peersRef, snap=>{
    const obj = snap.val() || {};
    const others = Object.keys(obj).filter(id=>id!==peerId);
    renderPeers(others);
  });

  // استمع للإشارات الموجهة إليك
  const mySigRef = ref(db, `signals/${roomName}/${peerId}`);
  onChildAdded(mySigRef, async snap=>{
    const msg = snap.val(); if(!msg) return;
    const from = msg.from;
    console.log('recv msg', msg);
    if(msg.type === 'offer'){
      // رد على العرض
      const pc = await createPC(from, false);
      await pc.setRemoteDescription(msg.sdp).catch(e=>console.warn('setRemoteDescription offer failed',e));
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);
      sendSig(from, { from: peerId, type: 'answer', sdp: pc.localDescription });
      // بعد الرد، نعالج أي مرشحين مجمّعين
      (candidateQueues[from]||[]).forEach(c=>pc.addIceCandidate(c).catch(()=>{}));
      candidateQueues[from] = [];
    }
    else if(msg.type === 'answer'){
      if(pcs[from]){
        await pcs[from].setRemoteDescription(msg.sdp).catch(e=>console.warn('setRemoteDescription answer failed',e));
        answered[from] = true;
        // أوقف إعادة إرسال العرض
        clearInterval(offerTimers[from]);
        offerTimers[from] = null;
        // اطبق أي مرشحين مؤجلين
        (candidateQueues[from]||[]).forEach(c=>pcs[from].addIceCandidate(c).catch(()=>{}));
        candidateQueues[from] = [];
      }
    }
    else if(msg.type === 'ice'){
      if(pcs[from]){
        pcs[from].addIceCandidate(msg.candidate).catch(()=>{});
      } else {
        // إذا pc غير جاهز بعد، خزّن المرشح مؤقتًا
        candidateQueues[from] = candidateQueues[from] || [];
        candidateQueues[from].push(msg.candidate);
      }
    }
    // امسح الرسالة بعد معالجتها (تنظيف)
    remove(snap.ref).catch(()=>{});
  });

  // تهيئة: اتصل بكل الأقران الموجودين الآن (اجلب قائمة الموجودين)
  const snap = await get(ref(db, `rooms/${roomName}/peers`));
  const present = snap.val() || {};
  for(const id in present){
    if(id === peerId) continue;
    // انشئ اتصال وكن offerer
    await createPC(id, true);
  }

  setStatus(`✅ متصل في "${roomName}" — اضغط زر تفعيل الصوت (إذا ظهر).`);
  // عرض الoverlay لالتقاط تفاعل المستخدم لتمكين التشغيل
  overlay.style.display = 'flex';

  // فور الانضمام، حاول resume AudioContext (للمتصفحات اللي تحتاج تفاعل)
  await resumeAudioContext();
}

/* ====== دالة إنشاء RTCPeerConnection مع retry للـ offer ====== */
async function createPC(otherId, offerer=false){
  if(pcs[otherId]) return pcs[otherId];
  console.log('createPC', otherId, 'offerer=', offerer);
  const pc = new RTCPeerConnection(config);
  pcs[otherId] = pc;
  answered[otherId] = false;
  candidateQueues[otherId] = candidateQueues[otherId] || [];

  // أضف المسارات المحلية
  if(localStream) localStream.getTracks().forEach(t=>pc.addTrack(t, localStream));

  pc.ontrack = (e)=>{
    console.log('ontrack from', otherId, e.streams);
    let a = audios[otherId];
    if(!a){
      a = document.createElement('audio');
      a.autoplay = true;
      a.playsInline = true;
      a.controls = false;
      a.muted = false;
      a.setAttribute('playsinline','');
      audios[otherId] = a;
      peersEl.appendChild(a);
    }
    a.srcObject = e.streams[0];
    // محاولة تشغيل العنصر فورًا (بعد تفعيل الصوت)
    a.play().catch(()=>{});
    setStatus(`🎧 استقبال صوتي من ${otherId}`);
  };

  pc.onicecandidate = (ev)=>{
    if(ev.candidate){
      sendSig(otherId, { from: peerId, type: 'ice', candidate: ev.candidate });
    }
  };

  pc.onconnectionstatechange = ()=>{
    console.log('connectionState', otherId, pc.connectionState);
    if(pc.connectionState === 'disconnected' || pc.connectionState === 'failed' || pc.connectionState === 'closed'){
      // نظف
      closePeer(otherId);
    }
  };

  // إذا دورنا offerer — انشئ عرض وارسله (مع retry)
  if(offerer){
    const doOffer = async ()=>{
      try{
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        sendSig(otherId, { from: peerId, type: 'offer', sdp: pc.localDescription });
      }catch(e){
        console.warn('offer error', e);
      }
    };
    // ارسال أولي ثم تكرار حتى يصل answer أو يصير تجاوز وقتي
    await doOffer();
    offerTimers[otherId] = setInterval(async ()=>{
      if(answered[otherId]) { clearInterval(offerTimers[otherId]); offerTimers[otherId]=null; return; }
      console.log('resend offer to', otherId);
      await doOffer();
    }, OFFER_RETRY_MS);
  }
  return pc;
}

/* ====== send signal helper ====== */
function sendSig(target, data){
  push(ref(db, `signals/${roomName}/${target}`), data).catch(e=>console.warn('sendSig failed',e));
}

/* ====== UI render peers ====== */
function renderPeers(list){
  peersEl.innerHTML = '';
  if(!list.length){
    peersEl.innerHTML = '<div class="peer">لا أحد متصل حالياً</div>';
    return;
  }
  list.forEach(id=>{
    const div = document.createElement('div');
    div.className = 'peer';
    div.textContent = '🎙️ مستخدم ' + id;
    peersEl.appendChild(div);
  });
}

/* ====== كتم المايك ====== */
function toggleMic(){
  micEnabled = !micEnabled;
  localStream?.getAudioTracks().forEach(t=>t.enabled = micEnabled);
  muteBtn.textContent = micEnabled ? '🔇 كتم المايك' : '🎙️ تشغيل المايك';
}

/* ====== تفعيل تشغيل الصوت (زر المستخدم) ====== */
async function enableAudioPlayback(){
  // حاول resume AudioContext و play لكل عنصر صوت إن وجد
  await resumeAudioContext();
  Object.values(audios).forEach(a=>{
    try{ a.muted = false; a.play().catch(()=>{}); }catch{}
  });
  overlay.style.display = 'none';
  setStatus('🔊 تم تفعيل الصوت — الآن يجب سماع الطرف الآخر إذا الاتصال ناجح');
}

/* ====== إغلاق/تنظيف peer معين ====== */
function closePeer(id){
  try{
    if(pcs[id]){
      pcs[id].close();
      delete pcs[id];
    }
    if(audios[id]){
      audios[id].srcObject = null;
      audios[id].remove();
      delete audios[id];
    }
    if(offerTimers[id]){ clearInterval(offerTimers[id]); offerTimers[id]=null; }
    candidateQueues[id] = [];
  }catch(e){ console.warn('closePeer error',e); }
}

/* ====== مغادرة الغرفة (تنظيف كامل) ====== */
async function leaveRoom(){
  // اغلق كل الـ PCs
  Object.keys(pcs).forEach(id=>closePeer(id));
  // ازل سجلك من Firebase
  try{
    await remove(ref(db, `rooms/${roomName}/peers/${peerId}`));
  }catch(e){}
  // اغلق مسارات المايك
  localStream?.getTracks().forEach(t=>t.stop());
  localStream = null;
  // استرجع واجهة المستخدم
  joinBtn.disabled = false;
  roomInput.disabled = false;
  muteBtn.style.display = 'none';
  leaveBtn.style.display = 'none';
  setStatus('غير متصل');
  overlay.style.display = 'none';
  peersEl.innerHTML = '<div class="peer">لا أحد متصل حالياً</div>';
}

/* ====== تنظيف عند إغلاق التبويب ====== */
window.addEventListener('beforeunload', async ()=>{
  try{ await remove(ref(db, `rooms/${roomName}/peers/${peerId}`)); }catch{}
});

/* ====== مفيدة للتتبع في console (اختياري) ====== */
console.log('peerId', peerId);

</script>
</body>
</html>
