<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>🎧 School Voice — الرومات الصوتية</title>
  <style>
    body {
      margin:0;
      font-family:'Tajawal',sans-serif;
      background:linear-gradient(135deg,#010817,#082044);
      color:#eaf1ff;
      display:flex;
      flex-direction:column;
      min-height:100vh;
      text-align:center;
    }
    header {
      background:#041025;
      padding:14px;
      font-weight:700;
      font-size:20px;
      color:#9fc7ff;
    }
    main {
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding:20px;
    }
    input {
      padding:10px;
      border-radius:8px;
      border:none;
      width:200px;
      margin:5px;
      background:#0b2a4d;
      color:#fff;
      text-align:center;
    }
    button {
      padding:10px 16px;
      border:none;
      border-radius:8px;
      background:#195ab7;
      color:#fff;
      cursor:pointer;
      font-weight:700;
      margin:4px;
      transition:0.3s;
    }
    button:hover { background:#2274ff; }
    ul {
      list-style:none;
      padding:0;
      margin:20px 0;
      width:90%;
      max-width:400px;
    }
    li {
      background:rgba(255,255,255,0.05);
      padding:12px;
      border-radius:10px;
      margin:6px 0;
      cursor:pointer;
      transition:0.3s;
    }
    li:hover { background:rgba(255,255,255,0.15); }
    #jitsi-container {
      width:100%;
      max-width:900px;
      height:550px;
      margin-top:20px;
      border-radius:12px;
      overflow:hidden;
      display:none;
    }
    .controls {
      margin-top:10px;
      display:flex;
      justify-content:center;
      gap:10px;
    }
    .danger { background:#b72d2d; }
  </style>
</head>
<body>
  <header>🎧 School Voice — دردشة المدرسة الصوتية</header>
  <main>
    <div id="homeView">
      <input type="text" id="roomName" placeholder="اسم الروم">
      <div>
        <button id="createBtn">إنشاء روم</button>
        <button id="refreshBtn">🔄 تحديث الرومات</button>
      </div>
      <ul id="roomsList"></ul>
    </div>

    <div id="roomView" style="display:none;">
      <h3 id="roomTitle"></h3>
      <div id="jitsi-container"></div>
      <div class="controls">
        <button id="muteBtn">🎙️ كتم / فتح المايك</button>
        <button id="leaveBtn" class="danger">🚪 مغادرة</button>
      </div>
    </div>
  </main>

  <!-- مكتبة Jitsi -->
  <script src="https://meet.jit.si/external_api.js"></script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getDatabase, ref, set, get, onValue, remove } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    // ✅ إعداد Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAQ6gD7dayX_VRzSIsI5UecS212Ki4N16o",
      authDomain: "school-voice-1b1dc.firebaseapp.com",
      databaseURL: "https://school-voice-1b1dc-default-rtdb.firebaseio.com",
      projectId: "school-voice-1b1dc",
      storageBucket: "school-voice-1b1dc.firebasestorage.app",
      messagingSenderId: "990135804919",
      appId: "1:990135804919:web:38c050a3a2ed1cb8d304f2",
      measurementId: "G-Y8Z1NP232P"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const roomsList = document.getElementById("roomsList");
    const roomNameInput = document.getElementById("roomName");
    const homeView = document.getElementById("homeView");
    const roomView = document.getElementById("roomView");
    const roomTitle = document.getElementById("roomTitle");

    let api = null;
    let currentRoom = null;

    // 🔹 إنشاء روم جديدة
    async function createRoom() {
      const room = roomNameInput.value.trim();
      if (!room) return alert("❗اكتب اسم الروم أولاً");
      await set(ref(db, "rooms/" + room), {
        active: true,
        createdAt: Date.now()
      });
      openRoom(room);
    }

    // 🔹 فتح الروم
    async function openRoom(room) {
      const snapshot = await get(ref(db, "rooms/" + room));
      if (!snapshot.exists()) return alert("❌ الروم غير متاحة حاليًا");

      currentRoom = room;
      homeView.style.display = "none";
      roomView.style.display = "block";
      roomTitle.textContent = "🎧 الروم: " + room;

      const domain = "meet.jit.si";
      const options = {
        roomName: room,
        parentNode: document.getElementById("jitsi-container"),
        configOverwrite: { startWithVideoMuted: true },
        interfaceConfigOverwrite: { TOOLBAR_BUTTONS: ["microphone","hangup","chat","tileview"] }
      };
      api = new JitsiMeetExternalAPI(domain, options);
      document.getElementById("jitsi-container").style.display = "block";

      api.addEventListener("participantLeft", checkIfRoomEmpty);
    }

    // 🔹 كتم / فتح المايك
    document.getElementById("muteBtn").onclick = () => {
      if (api) api.executeCommand("toggleAudio");
    };

    // 🔹 مغادرة الروم
    document.getElementById("leaveBtn").onclick = () => {
      if (api) api.executeCommand("hangup");
      roomView.style.display = "none";
      homeView.style.display = "block";
      document.getElementById("jitsi-container").style.display = "none";
      api = null;
      currentRoom = null;
    };

    // 🔹 تحديث قائمة الرومات
    function refreshRooms() {
      onValue(ref(db, "rooms"), (snapshot) => {
        roomsList.innerHTML = "";
        snapshot.forEach(child => {
          const name = child.key;
          const li = document.createElement("li");
          li.textContent = "🎤 " + name;
          li.onclick = () => openRoom(name);
          roomsList.appendChild(li);
        });
      });
    }

    // 🔹 حذف الروم إذا فاضية (تلقائي)
    async function checkIfRoomEmpty() {
      if (!currentRoom) return;
      const roomRef = ref(db, "rooms/" + currentRoom);
      const snapshot = await get(roomRef);
      if (snapshot.exists()) {
        remove(roomRef); // يحذفها لو فاضية
      }
    }

    // 🔹 روابط الأزرار
    document.getElementById("createBtn").onclick = createRoom;
    document.getElementById("refreshBtn").onclick = refreshRooms;

    // أول تحميل
    refreshRooms();
  </script>
</body>
</html>
